---
title: dynamic-form
mode: mobile
nav:
  title: 通用组件
  path: /components
group:
  path: /components/base
---

## 需求:

移动销售的表单体量较大，字段复杂，业务复杂。要求表单尽能在业务计算的时候少 render。  
同时所有表单字段实现配置化渲染.

## 设计思路：

现有的表单框架都是基于 react 的 state 或者 redux 来存储管理整个表单信息的。在移动销售表单业务中需要频繁使用表单联动验证功能，这些表单框架都会频繁触发整个大表单的 render。

1.此框架使用 react 的 useRef api 来存储整个表单信息。当修改 useRef 中的表单信息时不会触发 react 表单的重新 render。

2.把 render 的权力下放到每个字段组件 Filed 组件中，由字段组件 Filed 自行决定是否重新 render 自己。

3.每个字段组件只需要订阅来自 useRef 的消息，当 useRef 里的表单更新时实时计算更新自己的状态决定自己是否重新 render。
这里的监听订阅模式采用 rxjs 的 observe 工具实现。

4.当某些情况下需要真的重新 render 整个表单的时候（比如表单字段需要在界面上重新分组），框架提供依赖监听函数，调用这个函数传递的方法参数控制整体表单重新 render，根据业务场景灵活主动重新 render 整个表单。

## DynamicForm

```tsx
/**
 * title: 动态表单
 */
import React from 'react';
import { Checkbox, Button, InputItem } from 'antd-mobile';
import DynamicForm, {
  InitValue,
  FiledValue,
  LabelProps,
} from 'components/dynamic-form';

const BoxList = props => {
  const CheckboxItem = Checkbox.CheckboxItem;
  const { value: list, onChange } = props;
  const setList = (cur, e) => {
    const checked = e.target.checked;
    list.forEach(li => {
      if (li.label === cur.label) {
        li.value = checked;
      }
    });
    onChange(list);
  };
  return (
    <div>
      {list
        .filter(li => li.hide !== true)
        .map(li => (
          <CheckboxItem
            key={li.label}
            defaultChecked={li.value}
            onChange={setList.bind(this, li)}
          >
            {li.label}
          </CheckboxItem>
        ))}
    </div>
  );
};

const Input = ({ value, onChange }) => {
  return (
    <input
      className="border-none"
      style={{ borderBottom: '1px solid #BFBFBF' }}
      value={value}
      onChange={e => onChange(e.target.value)}
    />
  );
};

const mapComponent = {
  input: Input,
  list: BoxList,
};

const mapValidate = {
  required: v => {
    return !!v ? true : '该字段需要必填!';
  },
};

const mapRelay = {
  weightToHeight: (getFormFiled, currentFiled) => {
    const height = getFormFiled('height').value;
    currentFiled.value = height > 80 ? ((height - 80) * 7) / 10 : 0;
    return currentFiled;
  },

  fistValidate: (getFormFiled, currentFiled, updateForm) => {
    const list = getFormFiled('mutilist1').value;
    const item = list.find(li => li.label === '房子');
    const oldValidate = currentFiled.validate;
    currentFiled.validate = item && item.value ? 'required' : undefined;
    if (oldValidate !== currentFiled.validate) {
      updateForm(currentFiled);
    }
    return currentFiled;
  },
  secondValidate: (getFormFiled, currentFiled) => {
    const list = getFormFiled('mutilist1').value;
    const items = list.filter(li => li.value === true);
    if (items.length > 2) {
      currentFiled.hide = true;
    } else if (items.length > 1 && items.length <= 2) {
      currentFiled.hide = false;
      currentFiled.value.forEach(li => {
        if (li.label == '富') {
          li.hide = false;
        }
      });
    } else {
      currentFiled.hide = false;
      currentFiled.value.forEach(li => {
        if (li.label == '富') {
          li.hide = true;
        }
      });
    }

    const weight = getFormFiled('weight').value;
    if (weight > 80) {
      currentFiled.value.forEach(li => {
        if (li.label == '帅') {
          li.hide = true;
        }
      });
    } else {
      currentFiled.value.forEach(li => {
        if (li.label == '帅') {
          li.hide = false;
        }
      });
    }
    return currentFiled;
  },
};

const fieldUI = {
  boxList: ({ filedValue: { label, validate, isvalid, errMsg }, Comp }) => (
    <div>
      <div className="flexbox f12 mb6 text-left align-start">
        <div className="mr6 ml10 w40 flexbox">
          {label}
          {validate === 'required' && !isvalid && (
            <span className="c_red">*</span>
          )}:
        </div>
        {Comp}
      </div>
      <div className="ml50">
        {!!errMsg && <div className="c_red f12">{errMsg}</div>}
      </div>
    </div>
  ),
  default: ({ filedValue: { label, validate, isvalid, errMsg }, Comp }) => (
    <div>
      <div className="flexbox f12 mb6 text-left middle">
        <div className="mr6 ml10 w40 flexbox">
          {label}
          {validate === 'required' && !isvalid && (
            <span className="c_red">*</span>
          )}:
        </div>
        {Comp}
      </div>
      <div className="ml50">
        {!!errMsg && <div className="c_red f12">{errMsg}</div>}
      </div>
    </div>
  ),
};
const submit = ({ isValid }) => (
  <div className="flexbox f-center">
    <Button className="w60 c_white" type="primary" disabled={!isValid}>
      提交
    </Button>
  </div>
);
export default () => {
  const { Field, getValues, formUI } = DynamicForm({
    initValue: {
      firstName: {
        value: '张全蛋',
        label: '姓名',
        component: 'input',
        relay: 'fistValidate',
        validate: 'required',
      },
      lastName: {
        value: '男',
        label: '性别',
        component: 'input',
        validate: 'required',
      },
      height: {
        value: 170,
        label: '身高',
        component: 'input',
        debounce: 500,
      },
      weight: {
        value: 68,
        label: '体重',
        component: 'input',
        relay: 'weightToHeight',
      },
      mutilist1: {
        label: '特长',
        value: [
          { label: '房子', value: true },
          { label: '车子', value: false },
          { label: '票子', value: true },
        ],
        component: 'list',
        ui: 'boxList',
      },
      mutilist2: {
        label: '特点',
        relay: 'secondValidate',
        value: [
          { label: '高', value: false },
          { label: '富', value: false },
          { label: '帅', value: true },
        ],
        component: 'list',
        ui: 'boxList',
      },
    },
    formUI: { submit },
    fieldUI,
    mapComponent,
    mapRelay,
    mapValidate,
  });
  const { submit: Submit, tip: Tip } = formUI;
  const fieldValues = getValues();
  const requiredFileds = {}; // 必填项分组
  const notReqiureFileds = {}; // 非必填项分组

  for (let key in fieldValues) {
    const field = fieldValues[key];
    if (field.validate === 'required') {
      requiredFileds[key] = field;
    } else {
      notReqiureFileds[key] = field;
    }
  }
  return (
    <div className="bg_white">
      <div className="f16 mt10 mb4">必填项：</div>
      {Object.keys(requiredFileds).map(name => (
        <Field name={name} />
      ))}
      <div className="f16 mt20 mb4">非必填项：</div>
      {Object.keys(notReqiureFileds).map(name => (
        <Field name={name} />
      ))}
      <Submit />
    </div>
  );
};
```

<API></API>
